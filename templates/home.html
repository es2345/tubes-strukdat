{% extends "base_shell.html" %} {% block title %}MyMusic – Home{% endblock %} {%
block content %}

<!-- KONTEN HOME -->
<div class="chip-row">
  <button class="chip chip--active">All</button>
</div>

<!-- Your Playlist -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Your Playlist</h2>
    <a
      href="{{ url_for('song_library', view='playlists') }}"
      class="section__link"
      data-shell-link
    >
      Show all
    </a>
  </div>

  <div class="card-row">
    {% for pl in root_playlists %} {# ambil cover playlist; kalau belum ada,
    pakai default_cover #} {% set first_song = pl.songs.first() %}
{% set card_cover =
  pl.cover_url
  or (first_song.cover_url if first_song and first_song.cover_url else none)
  or url_for('serve_cover', filename='default_cover.png')
%}


    <a
      href="{{ url_for('playlist_page_by_id', playlist_id=pl.id) }}"
      data-shell-link
      class="card playlist-card"
      style="text-decoration: none; color: inherit"
    >
      <div
        class="card__image"
        style="background-image:url('{{ card_cover }}');"
      ></div>

      <div class="card__title">{{ pl.name }}</div>
      <div class="card__subtitle">
        Playlist • {{ current_user.display_name }}
      </div>
    </a>
    {% endfor %} {# PLAYLIST DI DALAM FOLDER #} {% for folder in folders %} {%
    for pl in folder.playlists %} {% set first_song = pl.songs.first() %}
{% set card_cover =
  pl.cover_url
  or (first_song.cover_url if first_song and first_song.cover_url else none)
  or url_for('serve_cover', filename='default_cover.png')
%}


    <a
      href="{{ url_for('playlist_page_by_id', playlist_id=pl.id) }}"
      data-shell-link
      class="card playlist-card"
      style="text-decoration: none; color: inherit"
    >
      <div
        class="card__image"
        style="background-image:url('{{ card_cover }}');"
      ></div>

      <div class="card__title">{{ pl.name }}</div>
      <div class="card__subtitle">
        Playlist • {{ current_user.display_name }}
      </div>
    </a>
    {% endfor %} {% endfor %}
  </div>
</section>

<!-- RIWAYAT LAGU YANG DIDENGARKAN (STACK) -->
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Listening History</h2>
    <a
      href="{{ url_for('song_library', view='history') }}"
      class="section__link"
      data-shell-link
    >
      Show all
    </a>
  </div>
  <div class="section__grid" id="listeningHistoryGrid">
    {# diisi JS seperti sudah kamu buat #}
  </div>
</section>

<section class="section">
  <div class="section__header">
    <h2 class="section__title">10 Random Songs (Refresh to shuffle)</h2>
    <a
      href="{{ url_for('song_library', view='all') }}"
      class="section__link"
      data-shell-link
    >
      Show all
    </a>
  </div>

  <div class="card-row">
    {% for song in random_songs %}
    <a
      href="{{ url_for('song_page', song_id=song.id) }}"
      data-shell-link
      style="text-decoration: none; color: inherit"
    >
      <article
        class="card song-card"
        data-title="{{ song.title }}"
        data-artist="{{ song.artist or 'Unknown artist' }}"
        data-cover="{{ song.cover_url or url_for('static', filename='images/default_cover.jpg') }}"
      >
        <div
          class="card__image"
          style="background-image:url('{{ song.cover_url or url_for('static', filename='images/default_cover.jpg') }}');"
        ></div>
        <div class="card__title">{{ song.title }}</div>
        <div class="card__subtitle">{{ song.artist or 'Unknown artist' }}</div>
      </article>
    </a>
    {% else %}
    <article class="card">
      <div class="card__image"></div>
      <div class="card__title">Belum ada lagu di library</div>
      <div class="card__subtitle">
        Tambahkan lagu lewat Admin panel untuk melihat daftar lagu di sini.
      </div>
    </article>
    {% endfor %}
  </div>
</section>




{# ALBUMS #}
<section class="section">
  <div class="section__header">
    <h2 class="section__title">Albums</h2>
    <a href="{{ url_for('song_library', view='albums') }}" data-shell-link class="section__link">Show all</a>
  </div>

  <div class="card-row">
    {% for al in albums %}
      <a
        href="{{ url_for('album_page', artist=al.artist, album=al.album) }}"
        data-shell-link
        class="card playlist-card"
        style="text-decoration:none; color:inherit;"
      >
        <div class="card__image" style="background-image:url('{{ al.cover_url }}');"></div>
        <div class="card__title">{{ al.album }}</div>
        <div class="card__subtitle">Album • {{ al.artist }} • {{ al.song_count }} lagu</div>
      </a>
    {% else %}
      <article class="card">
        <div class="card__image"></div>
        <div class="card__title">Belum ada album</div>
        <div class="card__subtitle">Isi kolom Album di lagu biar muncul di sini.</div>
      </article>
    {% endfor %}
  </div>
</section>



<section class="section">
  <div class="section__header">
    <h2 class="section__title">Browse by Genres</h2>
  </div>

  <div class="card-row">
    {% for g in genres %}
      <a
        href="{{ url_for('genre_page', genre_name=g.name) }}"
        data-shell-link
        class="card playlist-card genre-card"
        style="text-decoration:none; color:inherit;"
      >
        <div class="card__image genre-cover">
          <div class="genre-badge">{{ g.name }}</div>
        </div>
        <div class="card__title">{{ g.name }}</div>
        <div class="card__subtitle">Genre • {{ g.song_count }} lagu</div>
      </a>
    {% else %}
      <article class="card">
        <div class="card__image genre-cover">
          <div class="genre-badge">No Genre</div>
        </div>
        <div class="card__title">Belum ada genre</div>
        <div class="card__subtitle">Isi kolom Genre di lagu biar muncul di sini.</div>
      </article>
    {% endfor %}
  </div>
</section>

<style>
  .genre-cover{
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius: inherit;
    background:
      radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), rgba(0,0,0,0) 60%),
      linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,0));
  }
  .genre-badge{
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .08em;
    padding: 10px 12px;
    border-radius: 10px;
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    max-width: 90%;
    text-align:center;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* biar tiap card beda “vibe” dikit */
  .genre-card:nth-child(6n+1) .genre-cover { background: linear-gradient(135deg, rgba(0,170,255,.18), rgba(0,0,0,0)); }
  .genre-card:nth-child(6n+2) .genre-cover { background: linear-gradient(135deg, rgba(255,0,140,.18), rgba(0,0,0,0)); }
  .genre-card:nth-child(6n+3) .genre-cover { background: linear-gradient(135deg, rgba(0,255,170,.18), rgba(0,0,0,0)); }
  .genre-card:nth-child(6n+4) .genre-cover { background: linear-gradient(135deg, rgba(255,200,0,.18), rgba(0,0,0,0)); }
  .genre-card:nth-child(6n+5) .genre-cover { background: linear-gradient(135deg, rgba(180,0,255,.18), rgba(0,0,0,0)); }
  .genre-card:nth-child(6n+6) .genre-cover { background: linear-gradient(135deg, rgba(255,80,0,.18), rgba(0,0,0,0)); }
</style>



<script>
  // global, bisa dipanggil juga dari global_player.js
  window.renderListeningHistorySection = function () {
    const container = document.getElementById("listeningHistoryGrid");
    if (!container || !window.MusicHistory) return;

    container.innerHTML = "";

    const arr = window.MusicHistory.getListeningHistory(); // terbaru dulu
    if (!arr || arr.length === 0) {
      container.innerHTML =
        '<p class="section__empty">There are no songs, start listening now.</p>';
      return;
    }

    const seen = new Set();
    const unique = [];
    for (const t of arr) {
      if (!t || !t.id) continue;
      if (seen.has(t.id)) continue;
      seen.add(t.id);
      unique.push(t);
    }

    unique.slice(0, 10).forEach((track) => {
      const cover = track.cover_url || "";
      const title = track.title || "Unknown title";
      const artist = track.artist || "Unknown artist";

      const link = document.createElement("a");
      link.href = "/song/" + track.id;
      link.setAttribute("data-shell-link", "");
      link.style.textDecoration = "none";
      link.style.color = "inherit";

      const card = document.createElement("article");
      card.className = "card song-card";
      card.dataset.songId = track.id;

      card.innerHTML = `
        <div class="card__image" style="background-image:url('${cover}')"></div>
        <div class="card__title">${title}</div>
        <div class="card__subtitle">${artist}</div>
      `;

      link.appendChild(card);
      container.appendChild(link);
    });
  };

  // render awal saat halaman home dimuat
  if (window.MusicHistory) {
    window.renderListeningHistorySection();
  }
</script>
<div>. </div>
{% endblock %}
